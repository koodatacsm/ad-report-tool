<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å»£å‘Šé€±å ±ç”Ÿæˆå°å·¥å…· v27.0</title>
    <style>
        :root { --g-blue: #1a73e8; --g-gray: #5f6368; --bg: #f8f9fa; --border: #dadce0; --success: #34a853; --danger: #d93025; --accent: #673ab7; --warning: #fbc02d; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: white; padding: 12px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 100; }
        header h1 { margin: 0; font-size: 18px; color: var(--g-blue); }
        .update-date { font-size: 10px; color: #9aa0a6; font-weight: normal; margin-top: 4px; display: block; }
        main { display: flex; flex: 1; padding: 20px; gap: 20px; overflow: hidden; }
        .card { background: white; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; flex: 1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-header { padding: 12px 20px; border-bottom: 1px solid var(--border); background: #f1f3f4; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 20px; overflow-y: auto; flex: 1; }
        label { display: block; font-size: 11px; color: var(--g-gray); margin-bottom: 4px; font-weight: bold; text-transform: uppercase; }
        input[type="text"], input[type="date"], textarea, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        .import-box { background: #fffde7; border: 1px dashed #fbc02d; padding: 12px; border-radius: 4px; margin-bottom: 15px; }
        .platform-selector { display: flex; flex-wrap: wrap; gap: 10px; padding: 8px 0; }
        .platform-item { display: flex; align-items: center; font-size: 12px; cursor: pointer; color: var(--g-gray); }
        .platform-item input { margin-right: 4px; width: auto; }
        .metric-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; background: #fff; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; }
        .metric-item { display: flex; align-items: center; font-size: 12px; cursor: pointer; color: var(--g-gray); }
        .metric-item input { width: auto; margin-right: 6px; }
        .builder-box { background: #e8f0fe; padding: 15px; border-radius: 6px; border: 1px solid #c1d5fa; margin-top: 15px; }
        .stage-box { background: #fff; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-top: 10px; }
        #preview { white-space: pre-wrap; font-size: 13px; line-height: 1.6; color: #3c4043; background: white; padding: 20px; border-radius: 4px; border: 1px solid #ddd; min-height: 550px; }
        .btn { background: var(--g-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-add { background: var(--accent); border-radius: 20px; flex: 1; margin-top: 8px; }
        .btn-outline { background: white; color: var(--g-gray); border: 1px solid var(--border); font-size: 11px; padding: 4px 8px; }
        .hidden { display: none; }
        .guide-box { font-size: 11px; color: #5f6368; background: rgba(255,255,255,0.6); padding: 8px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #ddd; line-height: 1.5; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80vh; display: flex; flex-direction: column; }
        .history-list { overflow-y: auto; flex: 1; margin-top: 10px; }
        .history-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: grid; grid-template-columns: 100px 150px 1fr 50px; align-items: center; }
        .history-item:hover { background-color: #f5f5f5; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>å»£å‘Šé€±å ±ç”Ÿæˆå°å·¥å…· v27.0</h1>
            <span class="update-date">æœ€å¾Œæ›´æ–°æ—¥æœŸï¼š2026/01/21 (å«æœ¬æ©Ÿå°å­˜åŠŸèƒ½)</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" style="background:var(--accent)" onclick="openHistory()">ğŸ“œ æ­·å²ç´€éŒ„</button>
            <select id="templateLoader" style="width: 150px;" onchange="loadTemplate()"><option value="">è¼‰å…¥æ¬„ä½ç¯„æœ¬</option></select>
            <button class="btn btn-outline" onclick="exportTemplates()">ğŸ”— åŒ¯å‡ºè¨­å®š</button>
            <button class="btn btn-outline" onclick="importTemplates()">ğŸ“¥ åŒ¯å…¥è¨­å®š</button>
        </div>
    </header>
    <main>
        <div class="card">
            <div class="card-header">æ•¸æ“šåŒ¯å…¥èˆ‡ç­–ç•¥ç”Ÿæˆ <button class="btn" style="background:var(--success)" onclick="saveTemplate()">ğŸ’¾ å„²å­˜æ¬„ä½è¨­å®š</button></div>
            <div class="content">
                <div class="import-box">
                    <label>âš¡ æ•¸æ“šå¿«é€Ÿè§£æå™¨ (è²¼å…¥å ±è¡¨ç¸½è¨ˆåˆ—)</label>
                    <textarea id="bulkPaste" rows="2" placeholder="è²¼å…¥æ•¸æ“šå¾Œï¼Œä¸‹æ–¹æ¬„ä½å°‡è‡ªå‹•å¡«å…¥ä¸¦å‹¾é¸..." oninput="parseBulkData()"></textarea>
                </div>
                <div style="margin-bottom:10px;">
                    <label>å®¢æˆ¶åç¨±</label>
                    <input type="text" id="client" value="" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±..." oninput="run()">
                </div>
                
                <div style="margin-bottom:10px;">
                    <label>æŠ•æ”¾å¹³å° (å¯è¤‡é¸)</label>
                    <div class="platform-selector">
                        <label class="platform-item"><input type="checkbox" class="p-check" value="Google PMax" onchange="run()"> Google PMax</label>
                        <label class="platform-item"><input type="checkbox" class="p-check" value="Google GDN" onchange="run()"> Google GDN</label>
                        <label class="platform-item"><input type="checkbox" class="p-check" value="Google KWS" onchange="run()"> Google KWS</label>
                        <label class="platform-item"><input type="checkbox" class="p-check" value="Meta" onchange="run()"> Meta</label>
                        <label class="platform-item"><input type="checkbox" class="p-check" value="LINE" onchange="run()"> LINE</label>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1;"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="sDate" onchange="run()"></div>
                    <div style="flex:1;"><label>çµæŸæ—¥æœŸ</label><input type="date" id="eDate" onchange="run()"></div>
                </div>
                
                <label style="color:var(--g-blue)">1. æ•¸æ“šç¸½è¦½æ¬„ä½ (è‡ªå‹•å‹¾é¸)</label>
                <div class="metric-selector">
                    <label class="metric-item"><input type="checkbox" class="m-check" value="imp" onchange="toggleInputs()"> æ›å…‰æ¬¡æ•¸</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="click" onchange="toggleInputs()"> é»æ“Šæ¬¡æ•¸</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="conv" onchange="toggleInputs()"> è½‰æ›æ•¸</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="ctr" onchange="toggleInputs()"> CTR</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="cpc" onchange="toggleInputs()"> é»æ“Šæˆæœ¬ (CPC)</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="cpa" onchange="toggleInputs()"> è½‰æ›æˆæœ¬</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="spend" onchange="toggleInputs()"> èŠ±è²»</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="progress" onchange="toggleInputs()"> èŠ±è²»é€²åº¦</label>
                </div>

                <div id="inputGrid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
                    <div id="div-imp" class="input-group hidden"><label>æ›å…‰</label><input type="text" id="v-imp" oninput="autoCheck('imp'); run()"></div>
                    <div id="div-click" class="input-group hidden"><label>é»æ“Š</label><input type="text" id="v-click" oninput="autoCheck('click'); run()"></div>
                    <div id="div-conv" class="input-group hidden"><label>è½‰æ›</label><input type="text" id="v-conv" oninput="autoCheck('conv'); run()"></div>
                    <div id="div-ctr" class="input-group hidden"><label>CTR%</label><input type="text" id="v-ctr" oninput="autoCheck('ctr'); run()"></div>
                    <div id="div-cpc" class="input-group hidden"><label>CPC</label><input type="text" id="v-cpc" oninput="autoCheck('cpc'); run()"></div>
                    <div id="div-cpa" class="input-group hidden"><label>CPA</label><input type="text" id="v-cpa" oninput="autoCheck('cpa'); run()"></div>
                    <div id="div-spend" class="input-group hidden"><label>èŠ±è²»</label><input type="text" id="v-spend" oninput="autoCheck('spend'); run()"></div>
                    <div id="div-progress" class="input-group hidden"><label>é€²åº¦%</label><input type="text" id="v-progress" oninput="autoCheck('progress'); run()"></div>
                </div>

                <div class="builder-box">
                    <label style="color:var(--accent)">ğŸ” å„ªåŒ–åˆ†æç”Ÿæˆå™¨</label>
                    <div class="guide-box">
                        <strong>ğŸ’¡ å¡«å¯«æŒ‡å—ï¼š</strong> é¸æ“‡åˆ†é¡èˆ‡æŒ‡æ¨™ï¼Œè¼¸å…¥å¦‚ã€Œå“ç‰Œå­—é»æ“Šå¤§å¹…æˆé•·ã€å¾Œï¼Œé»æ“ŠæŒ‰éˆ•å³å¯ç”Ÿæˆå°ˆæ¥­å¥å‹ã€‚
                    </div>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <select id="level1" style="flex:1;" onchange="updateLevel2()">
                            <option value="å»£å‘Šæ•´é«”æ–¹å‘">å»£å‘Šæ•´é«”æ–¹å‘</option>
                            <option value="ç´ æèˆ‡ç‰ˆä½è¡¨ç¾">ç´ æèˆ‡ç‰ˆä½è¡¨ç¾</option>
                            <option value="å®¢å±¤èˆ‡å—çœ¾è¡¨ç¾">å®¢å±¤èˆ‡å—çœ¾è¡¨ç¾</option>
                            <option value="æœå°‹èˆ‡é—œéµå­—åˆ†æ">æœå°‹èˆ‡é—œéµå­—åˆ†æ</option>
                            <option value="ç«¶å“èˆ‡å¤–éƒ¨ç’°å¢ƒ">ç«¶å“èˆ‡å¤–éƒ¨ç’°å¢ƒ</option>
                        </select>
                        <select id="level2" style="flex:1;"></select>
                    </div>
                    <div style="display:flex; gap:8px; margin-bottom:8px; background:rgba(255,255,255,0.5); padding:8px; border-radius:4px;">
                        <div style="flex:1;"><label style="font-size:9px;">å‰æœŸæ•¸å€¼</label><input type="text" id="comp_prev" placeholder="æ­·å²æ•¸æ“š"></div>
                        <div style="flex:1;"><label style="font-size:9px;">æœ¬æœŸæ•¸å€¼</label><input type="text" id="comp_this" placeholder="ç¾åœ¨æ•¸æ“š"></div>
                    </div>
                    <input type="text" id="obsInput" placeholder="è¼¸å…¥äº‹å¯¦æè¿°..." style="width:100%; margin-bottom:8px;">
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-add" onclick="addStage('found')">åŠ åˆ°æœ¬é€±ç™¼ç¾</button>
                        <button class="btn btn-add" style="background:#ef6c00" onclick="addStage('executed')">åŠ åˆ°æœ¬é€±å·²åŸ·è¡Œ</button>
                        <button class="btn btn-add" style="background:#34a853" onclick="addStage('nextDirection')">åŠ åˆ°ä¸‹é€±èª¿æ•´æ–¹å‘</button>
                    </div>
                </div>
                <div class="stage-box"><label>ã€æœ¬é€±ç™¼ç¾ã€‘</label><textarea id="stageFound" rows="2" oninput="run()"></textarea></div>
                <div class="stage-box"><label>ã€æœ¬é€±å·²åŸ·è¡Œã€‘</label><textarea id="stageExecuted" rows="2" oninput="run()"></textarea></div>
                <div class="stage-box"><label>ã€ä¸‹é€±èª¿æ•´æ–¹å‘ã€‘</label><textarea id="stageNextDirection" rows="2" oninput="run()"></textarea></div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">æœ€çµ‚å ±è¡¨é è¦½ 
                <div>
                    <button class="btn" style="background:var(--warning); color:black;" onclick="saveToHistory()">ğŸ“¥ å°å­˜æœ¬é€±å ±è¡¨</button>
                    <button class="btn" onclick="copy()">è¤‡è£½å ±è¡¨æ–‡å­—</button>
                </div>
            </div>
            <div class="content" style="background: #f1f3f4;"><div id="preview"></div></div>
        </div>
    </main>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>ğŸ“œ æ­·å²é€±å ±ç´€éŒ„ (æœ¬æ©Ÿç«¯)</h2>
                <span class="close" onclick="closeHistory()">&times;</span>
            </div>
            <div id="historyList" class="history-list"></div>
        </div>
    </div>

    <script>
        const level2Options = {
            "å»£å‘Šæ•´é«”æ–¹å‘": ["è½‰æ›æˆæœ¬", "é»æ“Šæ•¸", "é»æ“Šæˆæœ¬", "é»é–±ç‡", "æ›å…‰æ¯”é‡", "èŠ±è²»é€²åº¦"],
            "ç´ æèˆ‡ç‰ˆä½è¡¨ç¾": ["é»é–±ç‡", "é»æ“Šæ•¸", "è½‰æ›æ•¸", "ç´ æè¡¨ç¾"],
            "å®¢å±¤èˆ‡å—çœ¾è¡¨ç¾": ["äº’å‹•ç‡", "é»æ“Šæˆæœ¬", "è½‰æ›æ•¸", "é»é–±ç‡"],
            "æœå°‹èˆ‡é—œéµå­—åˆ†æ": ["æœå°‹å­—è©", "é»æ“Šæ•¸", "é»æ“Šæˆæœ¬", "é»é–±ç‡", "è½‰æ›æ•¸"],
            "ç«¶å“èˆ‡å¤–éƒ¨ç’°å¢ƒ": ["ç«¶åƒ¹ç†±åº¦", "æ›å…‰æ¯”é‡", "å¸‚å ´éœ€æ±‚", "ç¯€æ…¶å› ç´ "]
        };

        const db = {
            "å»£å‘Šæ•´é«”æ–¹å‘": {
                found: ["è§€å¯Ÿå»£å‘Šæ•´é«”æˆæ•ˆï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºç›®å‰å¸³æˆ¶æŠ•éç­–ç•¥èƒ½æœ‰æ•ˆç¶­æŒç©©å®šèµ°å‹¢ã€‚", "æª¢è¦–æœ¬é€±æ•´é«”æ•¸æ“šï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºå¸‚å ´ç«¶åƒ¹ç’°å¢ƒä¹‹è®Šå‹•å°æˆæ•ˆç”¢ç”Ÿäº›è¨±æ³¢å‹•ã€‚", "æ•´é«”è¡¨ç¾æ–¹é¢ï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºå‡ºåƒ¹ç­–ç•¥èˆ‡é ç®—åˆ†é…ç›®å‰é‹ä½œç¬¦åˆé æœŸã€‚", "åˆ†ææœ¬æœŸæ•¸æ“šï¼Œ${val} ${comp}ï¼Œä¸»è¦å—æƒ æ–¼æµé‡å“è³ªå„ªåŒ–èˆ‡æ ¸å¿ƒå—çœ¾ä¹‹ç©©å®šè¡¨ç¾ã€‚", "è§€å¯Ÿæ•´é«”æˆæ•ˆï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºå»£å‘Šåœ¨æ ¸å¿ƒå—çœ¾ç¾¤è½ä¸­å…·å‚™ç©©å®šçš„è§¸åŠèˆ‡å¸å¼•åŠ›ã€‚"],
                executed: ["é‡å°æ•´é«”æˆæ•ˆ${val}ä¹‹ç‹€æ³ï¼Œæœ¬é€±å·²å®Œæˆé ç®—åˆ†é…èˆ‡å‡ºåƒ¹æ¬Šé‡ä¹‹å¾®èª¿ï¼Œå„ªåŒ–æŠ•æ”¾æ•ˆç›Šã€‚", "å› æ‡‰æ•¸æ“šæ³¢å‹•ï¼Œæœ¬é€±å·²åŸ·è¡Œæ»¾å‹•å¼èª¿æ•´ï¼Œå°‡é ç®—é›†ä¸­æ–¼é«˜æ•ˆæ™‚æ®µèˆ‡ç‰ˆä½ä»¥ç©©å®šæ•´é«”æˆæ•ˆã€‚", "é‡å°ç›®å‰${val}è¶¨å‹¢ï¼Œæœ¬é€±å·²å®Œæˆç›¸é—œå‡ºåƒ¹åƒæ•¸æ ¡æ­£ï¼Œä»¥ç©©å®šé•·æœŸä¹‹ç²å®¢æˆæœ¬ã€‚", "ç‚ºæå‡æ•´é«”è½‰æ›æ•ˆç›Šï¼Œæœ¬é€±å·²é‡æ–°æª¢è¦–å„å»£å‘Šæ´»å‹•ä¹‹é ç®—é…æ¯”ä¸¦å®Œæˆèª¿æ•´ã€‚"],
                nextDirection: ["ä¸‹é€±èª¿æ•´æ–¹å‘å°‡é‡å°æ•´é«”${val}ä¹‹è¶¨å‹¢æŒçºŒç›£æ§ï¼Œä¸¦è©•ä¼°æ˜¯å¦èª¿æ•´å»£å‘Šæ´»å‹•ä¿¡è™Ÿã€‚", "é è¨ˆä¸‹é€±åŠ å¼·å°æ•´é«”æˆæ•ˆèµ°å‹¢ä¹‹è§€å¯Ÿï¼Œè¦–æ•¸æ“šåé¥‹å‹•æ…‹é…ç½®é ç®—ä½”æ¯”ã€‚", "å¾ŒçºŒå°‡å¯†åˆ‡ç•™æ„${val}ä¹‹æ•¸æ“šè®ŠåŒ–ï¼Œä¸¦æ ¹æ“šè½‰æ›æˆæ•ˆè©•ä¼°å•Ÿå‹•å‚™é¸ä¹‹æŠ•æ”¾æ–¹æ¡ˆã€‚", "ä¸‹é€±è¨ˆç•«é‡å°æ•´é«”è¡¨ç¾${val}ä¹‹ç‹€æ³é€²è¡Œæ·±åº¦è¨ºæ–·ï¼Œä¸¦è¦–æƒ…æ³èª¿æ•´å‡ºåƒ¹ç­–ç•¥ä»¥æœ€å¤§åŒ–æ•ˆç›Šã€‚"]
            },
            "ç´ æèˆ‡ç‰ˆä½è¡¨ç¾": {
                found: ["ç´ æè¡¨ç¾æ–¹é¢ï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºç›®å‰è¦–è¦ºåˆ‡é»å°ç›®æ¨™å®¢ç¾¤ä¹‹å¸å¼•åŠ›ç‹€æ³ã€‚", "è§€å¯Ÿæœ¬é€±ç´ ææ•¸æ“šï¼Œä»¥${val} ${comp}è¡¨ç¾æœ€ç‚ºäº®çœ¼ï¼ŒæˆåŠŸå¼•ç™¼å—çœ¾å…±é³´ä¸¦å¸¶å‹•é»æ“Šã€‚", "æª¢è¦–åœ–ç‰‡èˆ‡æ–‡æ¡ˆæˆæ•ˆï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºå—çœ¾å°æ–¼è©²é¡å‹æºé€šè¨´æ±‚å…·æœ‰è¼ƒé«˜èˆˆè¶£åº¦ã€‚", "åˆ†æç´ æå›é¥‹ï¼Œ${val} ${comp}åæ˜ å‡ºç›®å‰ç´ ææŠ•æ”¾é€±æœŸèˆ‡è¦–è¦ºè¨­è¨ˆæ–¹å‘ç¬¦åˆå¸‚å ´è¶¨å‹¢ã€‚", "è§€å¯Ÿç‰ˆä½è¡¨ç¾ï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºç‰¹å®šç‰ˆä½ä¹‹äº’å‹•ç‡å„ªæ–¼å¹³å‡ï¼Œç‚ºæœ¬é€±ä¸»è¦æµé‡ä¾†æºã€‚"],
                executed: ["é‡å°ç´ æè¡¨ç¾${val}ä¹‹ç‹€æ³ï¼Œæœ¬é€±å·²å®Œæˆå»£å‘Šçµ„åˆå„ªåŒ–ï¼Œä¿ç•™é«˜æ•ˆè¦–è¦ºå…§å®¹æŒçºŒæŠ•éã€‚", "å·²å®Œæˆé»é–±è¡¨ç¾è¼ƒå·®ä¹‹ç´ ææ±°æ›ä½œæ¥­ï¼Œä¸¦é‡å°${val}ä¹‹æˆæ•ˆåé¥‹åŠ å¼·æ¨å»£åŠ›é“ã€‚", "é‡å°ç´ æå‘ˆç¾${val}ä¹‹ç–²ä¹è·¡è±¡ï¼Œæœ¬é€±å·²å”åŠ©æ›´æ–°æ–‡æ¡ˆåˆ‡é»ä¸¦åŠ å…¥æ–°ç‰ˆåœ–ç‰‡ä»¥ç¶­æŒå»£å‘Šæ–°é®®åº¦ã€‚", "æœ¬é€±å·²é‡å°è¡¨ç¾å„ªç•°ä¹‹ç´ æé€²è¡Œé ç®—åŠ ç¢¼ï¼Œä¸¦æš«åœæˆæ•ˆä¸ä½³ä¹‹ç‰ˆä½ä»¥ç¯€çœæˆæœ¬ã€‚"],
                nextDirection: ["ä¸‹é€±èª¿æ•´æ–¹å‘é è¨ˆé€²è¡Œç´ ææ›´æ–°ï¼Œé‡å°ã€Œ${val}ã€ä¹‹è¶¨å‹¢è¦åŠƒæ–°ç‰ˆè¦–è¦ºåˆ‡é»ã€‚", "ä¸‹é€±é è¨ˆæ¸¬è©¦æ–°ç´ æçµ„ä»¶ï¼Œé‡é»å°‡æ”¾åœ¨å¼·åŒ–${val}ä¹‹è¡¨ç¾ï¼Œä»¥æå‡æ•´é«”é»é–±å¸å¼•åŠ›ã€‚", "å¾ŒçºŒå°‡é‡å°ç´ ææˆæ•ˆé€²è¡Œå»¶ä¼¸è¨­è¨ˆï¼Œè¨ˆç•«å°‡è¡¨ç¾å„ªç•°ä¹‹ã€Œ${val}ã€é¢¨æ ¼æ“´å±•è‡³å…¶ä»–å»£å‘Šç¾¤çµ„ã€‚", "ä¸‹é€±è¨ˆç•«é‡å°ç‰ˆä½æ•ˆç›Šé€²è¡Œè©•ä¼°ï¼Œè¦–${val}ä¹‹è®ŠåŒ–èª¿æ•´ç‰ˆä½å‡ºåƒ¹è¨­å®šã€‚"]
            },
            "å®¢å±¤èˆ‡å—çœ¾è¡¨ç¾": {
                found: ["å®¢å±¤è¡¨ç¾æ–¹é¢ï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºç‰¹å®šå—çœ¾ç¾¤é«”ä¹‹è½‰æ›æ„é¡˜èˆ‡äº’å‹•è¡¨ç¾ã€‚", "åˆ†æå—çœ¾åˆ†ä½ˆç‹€æ³ï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºä¸»åŠ›æ ¸å¿ƒå®¢ç¾¤ä¹‹å—çœ¾ç‰¹å¾µèˆ‡æ•¸æ“šèµ°å‹¢å»åˆã€‚", "è§€å¯Ÿå¹´é½¡èˆ‡æ€§åˆ¥æ•¸æ“šï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºç›®å‰å»£å‘Šä¿¡è™Ÿèƒ½æœ‰æ•ˆè§¸åŠå…·æ½›åŠ›çš„ç›®æ¨™æ—ç¾¤ã€‚", "æª¢è¦–å—çœ¾æ•¸æ“šï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºè©²èˆˆè¶£æ—ç¾¤å°æ–¼æœ¬æª”æ´»å‹•ä¹‹åƒèˆ‡åº¦é«˜æ–¼å¹³å‡ã€‚", "åˆ†æå®¢ç¾¤è¼ªå»“ï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºæ–°é–‹ç™¼ä¹‹å—çœ¾æ¨™ç±¤å…·å‚™è‰¯å¥½çš„é–‹ç™¼æ½›åŠ›ã€‚"],
                executed: ["æœ¬é€±å·²é‡å°å—çœ¾${val}ä¹‹åé¥‹ï¼Œå¾®èª¿äº†ç‰¹å®šå¹´é½¡èˆ‡æ€§åˆ¥ç´šè·ä¹‹å‡ºåƒ¹å¢ç›Šæ¬Šé‡ã€‚", "é‡å°äº’å‹•ç‡ä¸ä½³ä¹‹å®¢ç¾¤æœ¬é€±å·²åŸ·è¡Œæ¸›åƒ¹å‹•ä½œï¼Œä¸¦å°‡é ç®—é›†ä¸­æ–¼æˆæ•ˆä½³ä¹‹å—çœ¾ã€‚", "å› æ‡‰å®¢å±¤${val}ä¹‹è®ŠåŒ–ï¼Œæœ¬é€±å·²é‡æ–°æ¢³ç†å—çœ¾ä¿¡è™Ÿæ¨™ç±¤ï¼Œèšç„¦é«˜å“è³ªé€²ç«™è¨ªå®¢ã€‚", "æœ¬é€±å·²é‡å°${val}ä¹‹é«˜æ½›åŠ›å—çœ¾é€²è¡Œç¨ç«‹è¨­å®šï¼Œä»¥è§€å¯Ÿå…¶é•·æœŸè½‰æ›åƒ¹å€¼ã€‚"],
                nextDirection: ["ä¸‹é€±èª¿æ•´æ–¹å‘é è¨ˆç›£æ¸¬å®¢å±¤${val}ä¹‹èµ°å‹¢ï¼Œä¸¦è¦–æˆæ•ˆè©•ä¼°æ˜¯å¦å°å…¥æ›´ç²¾ç´°ä¹‹æ¨™ç±¤éæ¿¾ã€‚", "ä¸‹é€±è¨ˆç•«é‡å°${val}ä¹‹å—çœ¾ç‰¹å¾µå¾®èª¿æ–‡æ¡ˆï¼Œè©•ä¼°æ˜¯å¦èƒ½é€²ä¸€æ­¥å¸¶å‹•è©²æ—ç¾¤ä¹‹è½‰åŒ–æ„é¡˜ã€‚", "å¾ŒçºŒå°‡é‡å°å—çœ¾æˆæ•ˆé€²è¡Œè¨ºæ–·ï¼Œè©•ä¼°æ˜¯å¦æ“´å¤§é¡ä¼¼å—çœ¾è¦æ¨¡ä»¥ç²å¾—æ›´å¤šæ½›åœ¨æµé‡ã€‚", "ä¸‹é€±é è¨ˆé‡å°è¡¨ç¾å„ªç•°ä¹‹${val}å®¢ç¾¤è¦åŠƒå°ˆå±¬ç´ æï¼Œä»¥æ·±åŒ–å“ç‰Œæºé€šã€‚"]
            },
            "æœå°‹èˆ‡é—œéµå­—åˆ†æ": {
                found: ["æœå°‹åˆ†æé¡¯ç¤ºï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºå»£å‘Šåœ¨é«˜åº¦æœå°‹æ„åœ–å—çœ¾ä¸­ä»å…·å‚™ä¸€å®šç«¶çˆ­åŠ›ã€‚", "è§€å¯Ÿé—œéµå­—è¡¨ç¾ï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºæ ¸å¿ƒå­—çµ„ä¹‹å‡ºåƒ¹ç­–ç•¥æˆåŠŸæ””æˆªç²¾æº–æµé‡ã€‚", "åˆ†ææœ¬é€±æœå°‹å­—è©ï¼Œè¨ªå®¢æœå°‹æ„åœ–èˆ‡ç”¢å“é«˜åº¦å»åˆï¼Œ${val} ${comp}ã€‚", "æª¢è¦–æœå°‹å ±å‘Šï¼Œ${val} ${comp}åæ˜ å‡ºç›®å‰å“ç‰Œæ ¸å¿ƒå­—èˆ‡ç”¢å“éœ€æ±‚å­—ä¹‹ç©©å®šä½”æ¯”ã€‚", "è§€å¯Ÿå­—è©è¶¨å‹¢ï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºå¸‚å ´å°æ–¼ç‰¹å®šè­°é¡Œä¹‹æœå°‹ç†±åº¦æœ‰æ‰€è®ŠåŒ–ã€‚"],
                executed: ["é‡å°é—œéµå­—${val}ä¹‹ç¾ç‹€ï¼Œæœ¬é€±å·²åŸ·è¡Œå­—è©æ¯”å°æ¨¡å¼å„ªåŒ–ä¸¦æ’é™¤ä¸ç›¸é—œä¹‹æµé‡é›œè¨Šã€‚", "å·²é‡å°æœå°‹å­—è©ä¸­ã€Œ${val}ã€ä¹‹ç‹€æ³é€²è¡Œéæ¿¾ï¼Œç¢ºä¿é ç®—é›†ä¸­æ–¼é«˜æ•ˆå­—çµ„ã€‚", "å› æ‡‰æœå°‹è®ŠåŒ–è¶¨å‹¢ï¼Œæœ¬é€±å·²é‡å°é—œéµå­—æ¸…å–®é€²è¡Œæ“´å……èˆ‡å¦å®šèª¿æ•´ï¼Œæ—¨åœ¨æå‡æµé‡ç´”åº¦ã€‚", "æœ¬é€±å·²é‡å°é«˜è½‰æ›æ½›åŠ›ä¹‹ã€Œ${val}ã€å­—çµ„æé«˜å‡ºåƒ¹ï¼Œä»¥çˆ­å–é¦–é é ‚ç«¯æ’åã€‚"],
                nextDirection: ["ä¸‹é€±èª¿æ•´æ–¹å‘è¨ˆç•«é‡å°ã€Œ${val}ã€ä¹‹æœé‡è¶¨å‹¢æŒçºŒè§€æ¸¬ï¼Œä¸¦æ ¹æ“šåé¥‹é€²è¡Œå‡ºåƒ¹èª¿æ•´ã€‚", "ä¸‹é€±é è¨ˆè©•ä¼°æ˜¯å¦æ–°å¢èˆ‡${val}ç›¸é—œä¹‹é•·å°¾é—œéµå­—ï¼Œä»¥ç¶²ç¾…æ›´å¤šæ½›åœ¨é€²ç«™æ©Ÿæœƒã€‚", "å¾ŒçºŒå°‡é‡å°é—œéµå­—ç«¶åƒ¹ç†±åº¦é€²è¡Œè¨ºæ–·ï¼Œè¨ˆç•«é‡å°è¡¨ç¾ä½³ä¹‹ã€Œ${val}ã€åŠ å¼·ç‰ˆä½ä¿è­·ã€‚", "ä¸‹é€±è¨ˆç•«é‡å°${val}ä¹‹å­—è©è¡¨ç¾é€²è¡Œæ·±åº¦åˆ†æï¼Œä¸¦è¦–ç«¶å“ç‹€æ³èª¿æ•´é ç®—é…æ¯”ã€‚"]
            },
            "ç«¶å“èˆ‡å¤–éƒ¨ç’°å¢ƒ": {
                found: ["å—å¤–éƒ¨ç’°å¢ƒå½±éŸ¿ï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºå¸‚å ´ç«¶åƒ¹æ…‹å‹¢èˆ‡éœ€æ±‚ç†±åº¦ä¹‹è®Šå‹•ã€‚", "è§€å¯Ÿç«¶å“å‹•æ…‹ï¼Œ${val} ${comp}ï¼Œç«¶çˆ­å°æ‰‹ä¹‹æŠ•æ”¾åŠ›é“å°æˆ‘æ–¹æˆæ•ˆç”¢ç”Ÿäº›è¨±å½±éŸ¿ã€‚", "è€ƒé‡ç¯€æ…¶æª”æœŸå› ç´ ï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºå¸‚å ´æ•´é«”æµé‡æœé‡åœ¨æ­¤æœŸé–“å‘ˆç¾ç‰¹å®šè¦å¾‹ã€‚", "åˆ†æå¸‚å ´ç‹€æ³ï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºç”¢æ¥­æ•´é«”éœ€æ±‚èˆ‡ç«¶åƒ¹æˆæœ¬å‘ˆç¾é€£å‹•è®ŠåŒ–ã€‚"],
                executed: ["é‡å°å¤–éƒ¨ç«¶åƒ¹${val}ä¹‹è¡æ“Šï¼Œæœ¬é€±å·²å”åŠ©èª¿é…æ—¥é ç®—èµ°é€Ÿä»¥ç¶­æŒæ›å…‰ä½”æ¯”ç©©å®šã€‚", "å› æ‡‰å¸‚å ´éœ€æ±‚æ³¢å‹•ï¼Œæœ¬é€±å·²å”åŠ©èª¿æ•´æŠ•æ”¾æ™‚æ®µèˆ‡å‡ºåƒ¹æ¨¡å‹ï¼Œç¢ºä¿ç«¶çˆ­å„ªå‹¢ã€‚", "é‡å°å¸‚å ´${val}ä¹‹ç¾ç‹€ï¼Œæœ¬é€±å·²åŸ·è¡Œå°æ‡‰ä¹‹å‚™é¸å„ªåŒ–æ–¹æ¡ˆï¼Œè‡´åŠ›æ–¼ç©©å®šé•·æœŸç²å®¢æ•ˆç›Šã€‚", "é¢å°ç«¶å“${val}ä¹‹ç­–ç•¥ï¼Œæœ¬é€±å·²é‡å°æ ¸å¿ƒé—œéµå­—é€²è¡Œé˜²ç¦¦æ€§å‡ºåƒ¹èª¿æ•´ã€‚"],
                nextDirection: ["ä¸‹é€±èª¿æ•´æ–¹å‘è¨ˆç•«è¦åŠƒå°æ‡‰æ–¹æ¡ˆï¼Œä»¥å› æ‡‰å¸‚å ´${val}æ‰€å¸¶ä¾†ä¹‹æ½›åœ¨æ³¢å‹•é¢¨éšªã€‚", "ä¸‹é€±é è¨ˆå¯†åˆ‡é—œæ³¨ç«¶å“${val}ä¹‹å‹•å‘ï¼Œä¸¦éš¨æ™‚æº–å‚™èª¿æ•´é ç®—ä½ˆå±€ä»¥æè¡›ç‰ˆä½ã€‚", "å¾ŒçºŒå°‡é‡å°ç¯€æ…¶å¾Œ${val}ä¹‹å¸‚å ´å›èª¿ç‹€æ³é€²è¡Œè©•ä¼°ï¼Œä¸¦å›æ­¸å¸¸æ…‹ä¹‹æŠ•éé‚è¼¯ã€‚", "ä¸‹é€±è¨ˆç•«é‡å°å¤–éƒ¨ç’°å¢ƒ${val}ä¹‹è®ŠåŒ–é€²è¡Œç­–ç•¥æ²™ç›¤æ¨æ¼”ï¼Œä»¥ç¢ºä¿å»£å‘Šæˆæ•ˆä¹‹ç©©å®šæ€§ã€‚"]
            }
        };

        function updateLevel2() {
            const l1 = document.getElementById('level1').value;
            const l2 = document.getElementById('level2');
            l2.innerHTML = "";
            level2Options[l1].forEach(opt => l2.add(new Option(opt, opt)));
        }

        function formatCompVal(val, metric) {
            if (!val) return "";
            let clean = val.replace(/[$,%\s]/g, '').replace('NT', '');
            let num = parseFloat(clean);
            if (isNaN(num)) return val;
            let formatted = new Intl.NumberFormat('zh-TW').format(num);
            if (["æˆæœ¬", "èŠ±è²»", "è²»ç”¨", "CPC", "CPA", "å–®æ¬¡é»æ“Šå‡ºåƒ¹"].some(k => metric.includes(k))) return "$" + formatted;
            if (["é»é–±ç‡", "é€²åº¦", "CTR", "äº’å‹•ç‡", "èŠ±è²»é€²åº¦"].some(k => metric.includes(k))) return formatted + "%";
            return formatted;
        }

        function autoCheck(key) {
            const ck = document.querySelector(`.m-check[value="${key}"]`);
            if (ck && !ck.checked) { ck.checked = true; toggleInputs(); }
        }

        function addStage(s) {
            const l1 = document.getElementById('level1').value, input = document.getElementById('obsInput').value;
            if (!input) return;
            const curVal = document.getElementById('comp_this').value, preVal = document.getElementById('comp_prev').value;
            let compStr = "";
            if (curVal && preVal) {
                const l2 = document.getElementById('level2').value;
                compStr = `(${formatCompVal(preVal, l2)} â†’ ${formatCompVal(curVal, l2)})`;
            }
            const pool = db[l1][s] || db[l1]["found"];
            const text = pool[Math.floor(Math.random() * pool.length)].replace('${val}', input).replace('${comp}', compStr);
            const targetId = 'stage' + s.charAt(0).toUpperCase() + s.slice(1);
            document.getElementById(targetId).value += (document.getElementById(targetId).value ? '\n' : '') + text;
            document.getElementById('obsInput').value = ""; document.getElementById('comp_this').value = ""; document.getElementById('comp_prev').value = ""; run();
        }

        function parseBulkData() {
            const raw = document.getElementById('bulkPaste').value.trim();
            if (!raw) return;
            const lines = raw.split(/\n/).map(line => line.split(/\t/));
            let data = lines.length < 2 ? raw.split(/\n/).map(line => line.trim().split(/\s{2,}/)) : lines;
            const h = data[0], v = data[data.length - 1];
            const m = { 
                imp: { keys: ["æ›å…‰", "å±•ç¤º"], exclude: ["æˆæœ¬", "æ¯”é‡"] },
                click: { keys: ["é»æ“Š", "é€£çµé»æ“Š"], exclude: ["æˆæœ¬", "å‡ºåƒ¹", "ç‡", "å–®æ¬¡"] },
                conv: { keys: ["è½‰æ›", "æˆæœ", "åå–®"], exclude: ["æˆæœ¬", "ç‡", "åƒ¹å€¼"] },
                ctr: { keys: ["CTR", "é»é–±ç‡"], exclude: [] },
                cpc: { keys: ["å–®æ¬¡é»æ“Šå‡ºåƒ¹", "å¹³å‡å–®æ¬¡é»æ“Šå‡ºåƒ¹", "CPC"], exclude: [] },
                cpa: { keys: ["CPA", "è½‰æ›æˆæœ¬"], exclude: [] },
                spend: { keys: ["èŠ±è²»", "è²»ç”¨"], exclude: ["æˆæœ¬", "å‡ºåƒ¹"] },
                progress: { keys: ["é€²åº¦", "èŠ±è²»é€²åº¦"], exclude: [] }
            };
            document.querySelectorAll('.m-check').forEach(ck => ck.checked = false);
            h.forEach((header, idx) => {
                for (let k in m) {
                    if (m[k].keys.some(key => header.includes(key)) && !m[k].exclude.some(ex => header.includes(ex))) {
                        let val = v[idx];
                        if (val) {
                            document.getElementById('v-' + k).value = val.replace(/[$,%\s]/g, '').replace('NT', '');
                            document.querySelector(`.m-check[value="${k}"]`).checked = true;
                        }
                    }
                }
            });
            toggleInputs(); run();
        }

        function toggleInputs() {
            document.querySelectorAll('.m-check').forEach(ck => {
                const div = document.getElementById('div-' + ck.value);
                ck.checked ? div.classList.remove('hidden') : div.classList.add('hidden');
            });
            run();
        }

        function run() {
            const get = (id) => document.getElementById(id).value;
            const s = get('sDate').replace(/-/g, '/') || '__/__/__', e = get('eDate').replace(/-/g, '/') || '__/__/__';
            let platforms = [];
            document.querySelectorAll('.p-check:checked').forEach(p => platforms.push(p.value));
            const platformText = platforms.length > 0 ? platforms.join(' + ') : '[å¹³å°]';
            let perf = [];
            const labels = {imp:"æ›å…‰æ¬¡æ•¸", click:"é»æ“Šæ¬¡æ•¸", conv:"è½‰æ›æ•¸", ctr:"CTR", cpc:"é»æ“Šæˆæœ¬", cpa:"è½‰æ›æˆæœ¬", spend:"èŠ±è²»", progress:"èŠ±è²»é€²åº¦"};
            document.querySelectorAll('.m-check:checked').forEach(ck => {
                perf.push(`${labels[ck.value]} ${formatCompVal(get('v-' + ck.value), labels[ck.value])}`);
            });
            document.getElementById('preview').innerText = `Dear all,\n\né™„ä»¶ç‚º ${get('client') || '[å®¢æˆ¶]'} ${platformText} å»£å‘Šå ±è¡¨ï¼Œè«‹æŸ¥é–±ï¼Œè¬è¬ã€‚\n\nã€å¸³æˆ¶ç‹€æ³èªªæ˜ã€‘\nå»£å‘Šæˆæ•ˆèµ°æœŸ ${s} - ${e}\nå»£å‘Šæˆæ•ˆï¼š${perf.join('ã€')}ã€‚\n\nã€å¸³æˆ¶å„ªåŒ–èªªæ˜ã€‘\næœ¬é€±ç™¼ç¾ï¼š\n${get('stageFound') || 'ç„¡'}\n\næœ¬é€±å·²åŸ·è¡Œï¼š\n${get('stageExecuted') || 'ç„¡'}\n\nä¸‹é€±èª¿æ•´æ–¹å‘ï¼š\n${get('stageNextDirection') || 'ç„¡'}\n\nBest regards,`;
        }

        function saveToHistory() {
            const client = document.getElementById('client').value;
            if (!client) return alert('è«‹å…ˆè¼¸å…¥å®¢æˆ¶åç¨±æ‰èƒ½å°å­˜ï¼');
            const historyItem = { id: Date.now(), timestamp: new Date().toLocaleString(), client, platform: Array.from(document.querySelectorAll('.p-check:checked')).map(p => p.value), dateRange: { start: document.getElementById('sDate').value, end: document.getElementById('eDate').value }, metrics: {}, stages: { found: document.getElementById('stageFound').value, executed: document.getElementById('stageExecuted').value, next: document.getElementById('stageNextDirection').value } };
            document.querySelectorAll('.m-check:checked').forEach(ck => { historyItem.metrics[ck.value] = document.getElementById('v-' + ck.value).value; });
            let history = JSON.parse(localStorage.getItem('tpl_v27_history') || '[]');
            history.unshift(historyItem); localStorage.setItem('tpl_v27_history', JSON.stringify(history));
            alert('âœ… å ±è¡¨å·²æˆåŠŸå°å­˜ï¼');
        }

        function openHistory() {
            const history = JSON.parse(localStorage.getItem('tpl_v27_history') || '[]');
            const list = document.getElementById('historyList'); list.innerHTML = '';
            if (history.length === 0) { list.innerHTML = '<div style="padding:20px; text-align:center;">ç›®å‰æ²’æœ‰æ­·å²ç´€éŒ„</div>'; } 
            else { history.forEach(item => {
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<div>${item.timestamp.split(' ')[0]}</div><div style="font-weight:bold;">${item.client}</div><div>${item.platform.join('+')}</div><button class="btn btn-outline" onclick="loadFromHistory(${item.id})">è¼‰å…¥</button>`;
                list.appendChild(div);
            }); }
            document.getElementById('historyModal').style.display = 'block';
        }

        function closeHistory() { document.getElementById('historyModal').style.display = 'none'; }

        function loadFromHistory(id) {
            const history = JSON.parse(localStorage.getItem('tpl_v27_history') || '[]');
            const item = history.find(i => i.id === id); if (!item) return;
            document.getElementById('client').value = item.client; document.getElementById('sDate').value = item.dateRange.start; document.getElementById('eDate').value = item.dateRange.end;
            document.getElementById('stageFound').value = item.stages.found; document.getElementById('stageExecuted').value = item.stages.executed; document.getElementById('stageNextDirection').value = item.stages.next;
            document.querySelectorAll('.p-check').forEach(ck => ck.checked = item.platform.includes(ck.value));
            document.querySelectorAll('.m-check').forEach(ck => ck.checked = false);
            for (let key in item.metrics) { if (document.getElementById('v-' + key)) { document.getElementById('v-' + key).value = item.metrics[key]; document.querySelector(`.m-check[value="${key}"]`).checked = true; } }
            toggleInputs(); run(); closeHistory(); alert('å·²è¼‰å…¥æ­·å²å ±è¡¨ï¼');
        }

        function saveTemplate() {
            const c = document.getElementById('client').value; if (!c) return alert('è«‹è¼¸å…¥å®¢æˆ¶åç¨±');
            const checks = Array.from(document.querySelectorAll('.m-check:checked')).map(ck => ck.value);
            const platforms = Array.from(document.querySelectorAll('.p-check:checked')).map(ck => ck.value);
            localStorage.setItem('tpl_v27_' + c, JSON.stringify({ platforms, checks }));
            updateLoader(); alert('æ¬„ä½è¨­å®šå·²å„²å­˜ï¼');
        }
        function updateLoader() {
            const l = document.getElementById('templateLoader'); l.innerHTML = '<option value="">è¼‰å…¥æ¬„ä½ç¯„æœ¬</option>';
            Object.keys(localStorage).filter(k => k.startsWith('tpl_v27_')).forEach(k => l.add(new Option(k.replace('tpl_v27_',''), k.replace('tpl_v27_',''))));
        }
        function loadTemplate() {
            const c = document.getElementById('templateLoader').value; if (!c) return;
            const d = JSON.parse(localStorage.getItem('tpl_v27_'+c));
            document.getElementById('client').value = c; 
            document.querySelectorAll('.p-check').forEach(ck => ck.checked = d.platforms.includes(ck.value));
            document.querySelectorAll('.m-check').forEach(ck => ck.checked = d.checks.includes(ck.value));
            toggleInputs(); run();
        }
        function copy() { navigator.clipboard.writeText(document.getElementById('preview').innerText); alert('å·²è¤‡è£½å ±è¡¨ï¼'); }
        function exportTemplates() { prompt("è¤‡è£½ä»£ç¢¼åˆ†äº«ï¼š", JSON.stringify(Object.fromEntries(Object.keys(localStorage).filter(k => k.startsWith('tpl_v27_')).map(k => [k, localStorage.getItem(k)])))); }
        function importTemplates() { const j = prompt("è²¼å…¥ä»£ç¢¼ï¼š"); if (j) { const d = JSON.parse(j); Object.keys(d).forEach(k => localStorage.setItem(k, d[k])); updateLoader(); alert('åŒ¯å…¥æˆåŠŸ'); run(); }}
        window.onload = () => { updateLevel2(); updateLoader(); run(); };
    </script>
</body>
</html>
