<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å»£å‘Šé€±å ±ç”Ÿæˆå°å·¥å…· v32.9</title>
    <style>
        :root { --g-blue: #1a73e8; --g-gray: #5f6368; --bg: #f8f9fa; --border: #dadce0; --success: #34a853; --danger: #d93025; --accent: #673ab7; --warning: #fbc02d; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: white; padding: 12px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 100; }
        header h1 { margin: 0; font-size: 18px; color: var(--g-blue); }
        main { display: flex; flex: 1; padding: 20px; gap: 20px; overflow: hidden; }
        .card { background: white; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; flex: 1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-header { padding: 12px 20px; border-bottom: 1px solid var(--border); background: #f1f3f4; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 20px; overflow-y: auto; flex: 1; }
        label { display: block; font-size: 11px; color: var(--g-gray); margin-bottom: 4px; font-weight: bold; text-transform: uppercase; }
        input[type="text"], input[type="date"], textarea, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        
        /* å¯Œæ–‡æœ¬å·¥å…·åˆ— */
        .toolbar { display: flex; gap: 4px; background: #f1f3f4; padding: 6px; border: 1px solid var(--border); border-bottom: none; border-radius: 4px 4px 0 0; align-items: center; flex-wrap: wrap; }
        .toolbar button { background: white; border: 1px solid #ccc; padding: 2px 8px; cursor: pointer; font-size: 12px; font-weight: bold; border-radius: 3px; }
        .toolbar button:hover { background: #e8eaed; }
        .editor { min-height: 100px; border: 1px solid var(--border); padding: 12px; border-radius: 0 0 4px 4px; font-size: 13px; background: white; overflow-y: auto; line-height: 1.6; outline: none; }
        .editor:focus { border-color: var(--g-blue); box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); }

        .import-box { background: #fffde7; border: 1px dashed #fbc02d; padding: 12px; border-radius: 4px; margin-bottom: 20px; }
        .platform-selector { display: flex; flex-wrap: wrap; gap: 10px; padding: 8px 0; }
        .metric-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; background: #fff; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; }
        .section-title { color: var(--g-blue); border-left: 4px solid var(--g-blue); padding-left: 8px; margin: 25px 0 10px 0; font-size: 14px; font-weight: bold; }
        .builder-box { background: #e8f0fe; padding: 15px; border-radius: 6px; border: 1px solid #c1d5fa; margin-top: 15px; }
        
        #preview { white-space: normal; font-size: 13px; line-height: 1.7; color: #3c4043; background: white; padding: 24px; border-radius: 4px; border: 1px solid #ddd; min-height: 650px; overflow-y: auto; }
        .btn { background: var(--g-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-add { background: var(--accent); border-radius: 20px; flex: 1; margin-top: 8px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>å»£å‘Šé€±å ±ç”Ÿæˆå°å·¥å…· v32.9</h1>
            <span style="font-size:10px; color:#9aa0a6;">æœ€å¾Œæ›´æ–°ï¼š2026/01/26 (å…¨åŠŸèƒ½å¯Œæ–‡æœ¬ç‰ˆ)</span>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:var(--accent)" onclick="openHistory()">ğŸ“œ æ­·å²ç´€éŒ„</button>
            <button class="btn" style="background:#fff; color:#5f6368; border:1px solid #dadce0" onclick="location.reload()">ğŸ”„ é‡ç½®</button>
        </div>
    </header>
    <main>
        <div class="card">
            <div class="card-header">æ•¸æ“šåŒ¯å…¥èˆ‡ç­–ç•¥ç”Ÿæˆ <button class="btn" style="background:var(--success)" onclick="saveTemplate()">ğŸ’¾ å„²å­˜ç¯„æœ¬</button></div>
            <div class="content">
                
                <div class="import-box">
                    <label>âš¡ æ•¸æ“šå¿«é€Ÿè§£æå™¨</label>
                    <textarea id="bulkPaste" rows="2" placeholder="è²¼å…¥æ•¸æ“š..." oninput="parseBulkData()"></textarea>
                </div>

                <div class="section-title">1. å®¢æˆ¶åç¨±</div>
                <input type="text" id="client" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±..." oninput="run()">

                <div class="section-title">2. æŠ•æ”¾å¹³å°</div>
                <div class="platform-selector">
                    <label style="font-size:12px;"><input type="checkbox" class="p-check" value="Google PMax" onchange="run()"> Google PMax</label>
                    <label style="font-size:12px;"><input type="checkbox" class="p-check" value="Google KWS" onchange="run()"> Google KWS</label>
                    <label style="font-size:12px;"><input type="checkbox" class="p-check" value="Google GDN" onchange="run()"> Google GDN</label>
                    <label style="font-size:12px;"><input type="checkbox" class="p-check" value="Meta" onchange="run()"> Meta</label>
                    <label style="font-size:12px;"><input type="checkbox" class="p-check" value="LINE" onchange="run()"> LINE</label>
                </div>

                <div class="section-title">3. å»£å‘Šèµ°æœŸ</div>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="sDate" onchange="run()"></div>
                    <div style="flex:1;"><label>çµæŸæ—¥æœŸ</label><input type="date" id="eDate" onchange="run()"></div>
                </div>

                <div class="section-title">4. å»£å‘Šæˆæ•ˆæ•¸æ“š</div>
                <div class="metric-selector">
                    <label style="font-size:12px;"><input type="checkbox" class="m-check" value="imp" onchange="toggleInputs()"> æ›å…‰</label>
                    <label style="font-size:12px;"><input type="checkbox" class="m-check" value="click" onchange="toggleInputs()"> é»æ“Š</label>
                    <label style="font-size:12px;"><input type="checkbox" class="m-check" value="ctr" onchange="toggleInputs()"> CTR</label>
                    <label style="font-size:12px;"><input type="checkbox" class="m-check" value="cpc" onchange="toggleInputs()"> CPC</label>
                    <label style="font-size:12px;"><input type="checkbox" class="m-check" value="spend" onchange="toggleInputs()"> èŠ±è²»</label>
                    <label style="font-size:12px;"><input type="checkbox" class="m-check" value="conv" onchange="toggleInputs()"> è½‰æ›</label>
                    <label style="font-size:12px;"><input type="checkbox" class="m-check" value="cpa" onchange="toggleInputs()"> CPA</label>
                    <label style="font-size:12px;"><input type="checkbox" class="m-check" value="cvr" onchange="toggleInputs()"> CVR</label>
                </div>
                <div id="inputGrid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
                    <div id="div-imp" class="hidden"><label>æ›å…‰</label><input type="text" id="v-imp" oninput="run()"></div>
                    <div id="div-click" class="hidden"><label>é»æ“Š</label><input type="text" id="v-click" oninput="run()"></div>
                    <div id="div-ctr" class="hidden"><label>CTR%</label><input type="text" id="v-ctr" oninput="run()"></div>
                    <div id="div-cpc" class="hidden"><label>CPC</label><input type="text" id="v-cpc" oninput="run()"></div>
                    <div id="div-spend" class="hidden"><label>èŠ±è²»</label><input type="text" id="v-spend" oninput="run()"></div>
                    <div id="div-conv" class="hidden"><label>è½‰æ›</label><input type="text" id="v-conv" oninput="run()"></div>
                    <div id="div-cpa" class="hidden"><label>CPA</label><input type="text" id="v-cpa" oninput="run()"></div>
                    <div id="div-cvr" class="hidden"><label>CVR%</label><input type="text" id="v-cvr" oninput="run()"></div>
                </div>

                <div class="section-title">5. èŠ±è²»é€²åº¦</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label style="color:var(--danger)">é€²åº¦ (%)</label><input type="text" id="v-progress" oninput="run()"></div>
                    <div>
                        <label>é€²åº¦ç‹€æ…‹</label>
                        <select id="v-status" onchange="toggleOtherStatus()">
                            <option value="é€²åº¦æ­£å¸¸">é€²åº¦æ­£å¸¸</option>
                            <option value="é€²åº¦è¶…å‰">é€²åº¦è¶…å‰</option>
                            <option value="é€²åº¦è½å¾Œ">é€²åº¦è½å¾Œ</option>
                            <option value="å…¶ä»–">å…¶ä»–ï¼šè‡ªè¡Œå¡«å¯«</option>
                        </select>
                        <input type="text" id="v-status-other" class="hidden" placeholder="è‡ªè¡Œå¡«å¯«ç‹€æ…‹..." style="margin-top:5px;" oninput="run()">
                    </div>
                </div>

                <div class="section-title">6. å„ªåŒ–åˆ†æèˆ‡å»ºè­°</div>
                <div class="builder-box">
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <input type="text" id="obsInput" placeholder="æè¿°(å¦‚:Aç´ æé»é–±é«˜)..." style="flex:2;">
                        <input type="text" id="comp_prev" placeholder="å‰æœŸ" style="flex:0.5;">
                        <input type="text" id="comp_this" placeholder="æœ¬æœŸ" style="flex:0.5;">
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-add" onclick="addStage('insight')">ï¼‹ æ•¸æ“šæ´å¯Ÿ</button>
                        <button class="btn btn-add" style="background:#ef6c00" onclick="addStage('action')">ï¼‹ ä¸‹ä¸€æ­¥è¡Œå‹•</button>
                    </div>
                </div>

                <div class="stage-box">
                    <label>ã€æ•¸æ“šæ´å¯Ÿã€‘</label>
                    <div class="toolbar">
                        <button onclick="exec('bold')">B</button>
                        <button onclick="exec('underline')">U</button>
                        <input type="color" onchange="exec('foreColor', this.value)" title="æ–‡å­—é¡è‰²">
                        <button onclick="exec('insertUnorderedList')">â€¢ æ¸…å–®</button>
                        <button onclick="exec('insertOrderedList')">1. æ¸…å–®</button>
                    </div>
                    <div id="stageInsight" class="editor" contenteditable="true" oninput="run()"></div>
                </div>

                <div class="stage-box">
                    <label>ã€ä¸‹ä¸€æ­¥è¡Œå‹•ã€‘</label>
                    <div class="toolbar">
                        <button onclick="exec('bold')">B</button>
                        <button onclick="exec('underline')">U</button>
                        <input type="color" onchange="exec('foreColor', this.value)" title="æ–‡å­—é¡è‰²">
                        <button onclick="exec('insertUnorderedList')">â€¢ æ¸…å–®</button>
                        <button onclick="exec('insertOrderedList')">1. æ¸…å–®</button>
                    </div>
                    <div id="stageAction" class="editor" contenteditable="true" oninput="run()"></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">æœ€çµ‚å ±è¡¨é è¦½ 
                <button class="btn" onclick="copy()">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
            </div>
            <div class="content" style="background: #f1f3f4;"><div id="preview"></div></div>
        </div>
    </main>

    <script>
        // æ ¸å¿ƒåŠŸèƒ½ï¼šåŸ·è¡Œå¯Œæ–‡æœ¬æŒ‡ä»¤
        function exec(cmd, val = null) { document.execCommand(cmd, false, val); run(); }

        function toggleOtherStatus() {
            const s = document.getElementById('v-status');
            const o = document.getElementById('v-status-other');
            s.value === 'å…¶ä»–' ? o.classList.remove('hidden') : o.classList.add('hidden');
            run();
        }

        function toggleInputs() {
            document.querySelectorAll('.m-check').forEach(ck => {
                const div = document.getElementById('div-' + ck.value);
                if(div) ck.checked ? div.classList.remove('hidden') : div.classList.add('hidden');
            });
            run();
        }

        function formatVal(val, metric) {
            if (!val) return "";
            let clean = val.toString().replace(/[$,%\s]/g, '');
            let num = parseFloat(clean);
            if (isNaN(num)) return val;
            let f = new Intl.NumberFormat('zh-TW').format(num);
            if (["CPC", "CPA", "èŠ±è²»"].some(k => metric.includes(k))) return "$" + f;
            if (["ç‡", "CTR", "CVR", "é€²åº¦"].some(k => metric.includes(k))) return f + "%";
            return f;
        }

        function run() {
            const get = (id) => {
                const e = document.getElementById(id);
                return e.contentEditable === "true" ? e.innerHTML : e.value;
            };

            const s = get('sDate').replace(/-/g, '/') || '__/__/__', e = get('eDate').replace(/-/g, '/') || '__/__/__';
            const platforms = Array.from(document.querySelectorAll('.p-check:checked')).map(p => p.value);
            
            // æŒ‡æ¨™æ’åº
            const order = ["imp", "click", "ctr", "cpc", "spend", "conv", "cpa", "cvr"];
            const labels = {imp:"æ›å…‰", click:"é»æ“Š", ctr:"CTR", cpc:"CPC", spend:"èŠ±è²»", conv:"è½‰æ›", cpa:"CPA", cvr:"CVR"};
            let perf = [];
            order.forEach(k => {
                if (document.querySelector(`.m-check[value="${k}"]`).checked) 
                    perf.push(`${labels[k]} ${formatVal(get('v-' + k), labels[k])}`);
            });

            const prog = get('v-progress');
            const status = document.getElementById('v-status').value === 'å…¶ä»–' ? get('v-status-other') : document.getElementById('v-status').value;
            let progLine = prog ? `ç›®å‰èŠ±è²»é€²åº¦ï¼š${prog}% (${status})<br>` : '';

            document.getElementById('preview').innerHTML = `Dear all,<br><br>` +
                `é™„ä»¶ç‚º ${get('client') || '[å®¢æˆ¶]'} ${platforms.join(' + ') || '[å¹³å°]'} å»£å‘Šé€±å ±ï¼Œè«‹æŸ¥é–±ã€‚<br><br>` +
                `ã€å¸³æˆ¶ç‹€æ³èªªæ˜ã€‘<br>` +
                `å»£å‘ŠæœŸé–“ï¼š${s} - ${e}<br>` +
                `å»£å‘Šæˆæ•ˆï¼š${perf.join('ã€')}<br>` +
                `${progLine}<br>` +
                `ã€å„ªåŒ–åˆ†æèˆ‡å»ºè­°ã€‘<br>` +
                `æ•¸æ“šæ´å¯Ÿï¼š<br>${get('stageInsight') || 'å°šç„¡æ´å¯Ÿå…§å®¹'}<br><br>` +
                `ä¸‹ä¸€æ­¥è¡Œå‹•ï¼š<br>${get('stageAction') || 'å°šç„¡è¡Œå‹•è¦åŠƒ'}<br><br>` +
                `Best regards,`;
        }

        function parseBulkData() {
            const raw = document.getElementById('bulkPaste').value.trim();
            if (!raw) return;
            const lines = raw.split(/\n/).map(line => line.split(/\t/));
            let data = lines.length < 2 ? raw.split(/\n/).map(line => line.trim().split(/\s{2,}/)) : lines;
            const h = data[0], v = data[data.length - 1];
            const m = { imp: ["æ›å…‰"], click: ["é»æ“Š"], ctr: ["CTR", "é»é–±ç‡"], cpc: ["CPC", "å–®æ¬¡é»æ“Š"], spend: ["èŠ±è²»", "è²»ç”¨"], conv: ["è½‰æ›"], cpa: ["CPA", "å–®æ¬¡è½‰æ›"], cvr: ["CVR", "è½‰æ›ç‡"], progress: ["é€²åº¦"] };
            h.forEach((header, idx) => {
                for (let k in m) {
                    if (m[k].some(key => header.includes(key))) {
                        let val = v[idx] ? v[idx].replace(/[$,%\s]/g, '') : "";
                        if (k === 'progress') document.getElementById('v-progress').value = val;
                        else if (document.getElementById('v-' + k)) {
                            document.getElementById('v-' + k).value = val;
                            document.querySelector(`.m-check[value="${k}"]`).checked = true;
                        }
                    }
                }
            });
            toggleInputs();
        }

        function addStage(type) {
            const input = document.getElementById('obsInput').value;
            if (!input) return;
            const cur = document.getElementById('comp_this').value, pre = document.getElementById('comp_prev').value;
            let compStr = (cur && pre) ? `(${formatVal(pre, 'æ•¸å€¼')} â†’ ${formatVal(cur, 'æ•¸å€¼')})` : "";
            const target = document.getElementById(type === 'insight' ? 'stageInsight' : 'stageAction');
            target.innerHTML += (target.innerHTML.trim() ? '<br>' : '') + `â€¢ ${input} ${compStr}`;
            document.getElementById('obsInput').value = ""; run();
        }

        function copy() {
            const p = document.getElementById('preview');
            const r = document.createRange(); r.selectNode(p);
            window.getSelection().removeAllRanges(); window.getSelection().addRange(r);
            document.execCommand('copy'); alert('å ±è¡¨å·²è¤‡è£½ï¼è²¼åˆ° Email å¯ä¿ç•™æ ¼å¼ã€‚');
        }
        
        // ç¯„æœ¬èˆ‡æ­·å²ç´€éŒ„å­˜å„² (LocalStorage)
        function saveTemplate() {
            const c = document.getElementById('client').value; if(!c) return alert('è«‹è¼¸å…¥åç¨±');
            localStorage.setItem('tpl_v32_'+c, JSON.stringify({
                platforms: Array.from(document.querySelectorAll('.p-check:checked')).map(p=>p.value),
                metrics: Array.from(document.querySelectorAll('.m-check:checked')).map(m=>m.value)
            })); alert('ç¯„æœ¬å„²å­˜æˆåŠŸ');
        }

        window.onload = () => { toggleInputs(); run(); };
    </script>
</body>
</html>
