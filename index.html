<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å»£å‘Šé€±å ±ç”Ÿæˆå°å·¥å…· v32.2 - å¯Œæ–‡æœ¬ç©©å®šé è¦½ç‰ˆ</title>
    <style>
        :root { --g-blue: #1a73e8; --g-gray: #5f6368; --bg: #f8f9fa; --border: #dadce0; --success: #34a853; --danger: #d93025; --accent: #673ab7; --warning: #fbc02d; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        header { background: white; padding: 12px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); z-index: 100; }
        header h1 { margin: 0; font-size: 18px; color: var(--g-blue); }
        .update-date { font-size: 10px; color: #9aa0a6; font-weight: normal; margin-top: 4px; display: block; }
        main { display: flex; flex: 1; padding: 20px; gap: 20px; overflow: hidden; }
        .card { background: white; border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; flex: 1; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .card-header { padding: 12px 20px; border-bottom: 1px solid var(--border); background: #f1f3f4; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 20px; overflow-y: auto; flex: 1; }
        label { display: block; font-size: 11px; color: var(--g-gray); margin-bottom: 4px; font-weight: bold; text-transform: uppercase; }
        input[type="text"], input[type="date"], textarea, select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        
        /* å¯Œæ–‡æœ¬ç·¨è¼¯å™¨æ¨£å¼ */
        .toolbar { display: flex; gap: 4px; background: #eee; padding: 4px; border: 1px solid var(--border); border-bottom: none; border-radius: 4px 4px 0 0; }
        .toolbar button { background: white; border: 1px solid #ccc; padding: 2px 6px; cursor: pointer; font-size: 11px; font-weight: bold; }
        .editor { min-height: 80px; border: 1px solid var(--border); padding: 10px; border-radius: 0 0 4px 4px; font-size: 13px; background: white; overflow-y: auto; line-height: 1.5; }
        
        .import-box { background: #fffde7; border: 1px dashed #fbc02d; padding: 12px; border-radius: 4px; margin-bottom: 15px; }
        .platform-selector { display: flex; flex-wrap: wrap; gap: 10px; padding: 8px 0; }
        .platform-item { display: flex; align-items: center; font-size: 12px; cursor: pointer; }
        .metric-selector { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; background: #fff; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; }
        .metric-item { display: flex; align-items: center; font-size: 12px; cursor: pointer; }
        .metric-item input { width: auto; margin-right: 6px; }
        .builder-box { background: #e8f0fe; padding: 15px; border-radius: 6px; border: 1px solid #c1d5fa; margin-top: 15px; }
        .stage-box { background: #fff; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-top: 10px; }
        
        /* é è¦½å€å¡Šè¨­å®š - é€™æ˜¯ä¿®å¾©é è¦½æ¶ˆå¤±çš„é‡é» */
        #preview { white-space: normal; font-size: 13px; line-height: 1.7; color: #3c4043; background: white; padding: 20px; border-radius: 4px; border: 1px solid #ddd; min-height: 550px; overflow-y: auto; }
        
        .btn { background: var(--g-blue); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-add { background: var(--accent); border-radius: 20px; flex: 1; margin-top: 8px; }
        .btn-outline { background: white; color: var(--g-gray); border: 1px solid var(--border); font-size: 11px; padding: 4px 8px; }
        .hidden { display: none; }
        
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 800px; border-radius: 8px; max-height: 80vh; display: flex; flex-direction: column; }
        .history-list { overflow-y: auto; flex: 1; margin-top: 10px; }
        .history-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: grid; grid-template-columns: 100px 150px 1fr 50px; align-items: center; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>å»£å‘Šé€±å ±ç”Ÿæˆå°å·¥å…· v32.1</h1>
            <span class="update-date">æœ€å¾Œæ›´æ–°ï¼š2026/01/22 (ç©©å®šé è¦½ç‰ˆ)</span>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn" style="background:var(--accent)" onclick="openHistory()">ğŸ“œ æ­·å²ç´€éŒ„</button>
            <button class="btn btn-outline" onclick="resetDefault()">ğŸ”„ é‡ç½®</button>
            <select id="templateLoader" style="width: 150px;" onchange="loadTemplate()"><option value="">é¸æ“‡å®¢æˆ¶ç¯„æœ¬</option></select>
            <button class="btn btn-outline" onclick="exportTemplates()">ğŸ”— åŒ¯å‡º</button>
            <button class="btn btn-outline" onclick="importTemplates()">ğŸ“¥ åŒ¯å…¥</button>
        </div>
    </header>
    <main>
        <div class="card">
            <div class="card-header">æ•¸æ“šåŒ¯å…¥èˆ‡ç­–ç•¥ç”Ÿæˆ <button class="btn" style="background:var(--success)" onclick="saveTemplate()">ğŸ’¾ å„²å­˜ç¯„æœ¬</button></div>
            <div class="content">
                <div class="import-box">
                    <label>âš¡ æ•¸æ“šå¿«é€Ÿè§£æå™¨</label>
                    <textarea id="bulkPaste" rows="2" placeholder="è²¼å…¥æ•¸æ“š..." oninput="parseBulkData()"></textarea>
                </div>
                
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:10px; margin-bottom:10px;">
                    <div><label>å®¢æˆ¶åç¨±</label><input type="text" id="client" placeholder="è¼¸å…¥åç¨±..." oninput="run()"></div>
                    <div><label style="color:var(--danger)">èŠ±è²»é€²åº¦ (%)</label><input type="text" id="v-progress" placeholder="å¦‚: 85" oninput="run()"></div>
                </div>
                
                <div style="margin-bottom:10px;">
                    <label>æŠ•æ”¾å¹³å°</label>
                    <div class="platform-selector">
                        <label class="platform-item"><input type="checkbox" class="p-check" value="Google PMax" onchange="run()"> Google PMax</label>
                        <label class="platform-item"><input type="checkbox" class="p-check" value="Meta" onchange="run()"> Meta</label>
                        <label class="platform-item"><input type="checkbox" class="p-check" value="LINE" onchange="run()"> LINE</label>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1;"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="sDate" onchange="run()"></div>
                    <div style="flex:1;"><label>çµæŸæ—¥æœŸ</label><input type="date" id="eDate" onchange="run()"></div>
                </div>
                
                <label style="color:var(--g-blue)">æˆæ•ˆæŒ‡æ¨™</label>
                <div class="metric-selector">
                    <label class="metric-item"><input type="checkbox" class="m-check" value="imp" onchange="toggleInputs()"> æ›å…‰</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="click" onchange="toggleInputs()"> é»æ“Š</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="conv" onchange="toggleInputs()"> è½‰æ›</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="ctr" onchange="toggleInputs()"> CTR</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="cpc" onchange="toggleInputs()"> CPC</label>
                    <label class="metric-item"><input type="checkbox" class="m-check" value="cpa" onchange="toggleInputs()"> CPA</label>
                </div>

                <div id="inputGrid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
                    <div id="div-imp" class="input-group hidden"><label>æ›å…‰</label><input type="text" id="v-imp" oninput="run()"></div>
                    <div id="div-click" class="input-group hidden"><label>é»æ“Š</label><input type="text" id="v-click" oninput="run()"></div>
                    <div id="div-conv" class="input-group hidden"><label>è½‰æ›</label><input type="text" id="v-conv" oninput="run()"></div>
                    <div id="div-ctr" class="input-group hidden"><label>CTR%</label><input type="text" id="v-ctr" oninput="run()"></div>
                    <div id="div-cpc" class="input-group hidden"><label>CPC</label><input type="text" id="v-cpc" oninput="run()"></div>
                    <div id="div-cpa" class="input-group hidden"><label>CPA</label><input type="text" id="v-cpa" oninput="run()"></div>
                </div>

                <div class="builder-box">
                    <label style="color:var(--accent)">ğŸ” å„ªåŒ–å»ºè­°ç”Ÿæˆ</label>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <select id="level1" style="flex:1;" onchange="updateLevel2()">
                            <option value="å»£å‘Šæ•´é«”æ–¹å‘">å»£å‘Šæ•´é«”æ–¹å‘</option>
                            <option value="ç´ æèˆ‡ç‰ˆä½è¡¨ç¾">ç´ æèˆ‡ç‰ˆä½è¡¨ç¾</option>
                            <option value="å®¢å±¤è¡¨ç¾">å®¢å±¤è¡¨ç¾</option>
                            <option value="å—çœ¾è¡¨ç¾">å—çœ¾è¡¨ç¾</option>
                            <option value="æœå°‹èˆ‡é—œéµå­—åˆ†æ">æœå°‹èˆ‡é—œéµå­—åˆ†æ</option>
                        </select>
                        <select id="level2" style="flex:1;"></select>
                    </div>
                    <div style="display:flex; gap:8px; margin-bottom:8px;">
                        <input type="text" id="obsInput" placeholder="æè¿°å…§å®¹..." style="flex:2;">
                        <input type="text" id="comp_prev" placeholder="å‰æœŸ" style="flex:0.5;">
                        <input type="text" id="comp_this" placeholder="æœ¬æœŸ" style="flex:0.5;">
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-add" onclick="addStage('insight')">ï¼‹ æ•¸æ“šæ´å¯Ÿ</button>
                        <button class="btn btn-add" style="background:#ef6c00" onclick="addStage('action')">ï¼‹ ä¸‹ä¸€æ­¥è¡Œå‹•</button>
                    </div>
                </div>

                <div class="stage-box">
                    <label>ã€æ•¸æ“šæ´å¯Ÿã€‘</label>
                    <div class="toolbar">
                        <button onclick="format('bold')">B</button>
                        <button onclick="format('underline')">U</button>
                        <input type="color" onchange="format('foreColor', this.value)" style="width:30px; height:18px;">
                    </div>
                    <div id="stageInsight" class="editor" contenteditable="true" oninput="run()"></div>
                </div>

                <div class="stage-box">
                    <label>ã€ä¸‹ä¸€æ­¥è¡Œå‹•ã€‘</label>
                    <div class="toolbar">
                        <button onclick="format('bold')">B</button>
                        <button onclick="format('underline')">U</button>
                        <input type="color" onchange="format('foreColor', this.value)" style="width:30px; height:18px;">
                    </div>
                    <div id="stageAction" class="editor" contenteditable="true" oninput="run()"></div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">æœ€çµ‚å ±è¡¨é è¦½ 
                <div>
                    <button class="btn" style="background:var(--warning); color:black;" onclick="saveToHistory()">ğŸ“¥ å°å­˜ç´€éŒ„</button>
                    <button class="btn" onclick="copy()">è¤‡è£½æ–‡å­—</button>
                </div>
            </div>
            <div class="content" style="background: #f1f3f4;">
                <div id="preview"></div>
            </div>
        </div>
    </main>

    <div id="historyModal" class="modal"><div class="modal-content"><div style="display:flex; justify-content:space-between; align-items:center;"><h2>ğŸ“œ æ­·å²ç´€éŒ„</h2><span class="close" onclick="closeHistory()">&times;</span></div><div id="historyList" class="history-list"></div></div></div>

    <script>
        const level2Options = { "å»£å‘Šæ•´é«”æ–¹å‘": ["æ›å…‰æ•¸", "é»æ“Šæ•¸", "é»æ“Šæˆæœ¬", "é»é–±ç‡", "è½‰æ›æ•¸", "è½‰æ›æˆæœ¬", "è½‰æ›ç‡", "ROAS"],  "ç´ æèˆ‡ç‰ˆä½è¡¨ç¾": ["é»é–±ç‡", "é»æ“Šæ•¸", "è½‰æ›æ•¸", "ç´ æè¡¨ç¾"],"å®¢å±¤èˆ‡å—çœ¾è¡¨ç¾": ["äº’å‹•ç‡", "é»æ“Šæˆæœ¬", "è½‰æ›æ•¸"],"æœå°‹èˆ‡é—œéµå­—åˆ†æ": ["æœå°‹å­—è©", "é»æ“Šæ•¸", "è½‰æ›æ•¸"]
        const db = {
            "å»£å‘Šæ•´é«”æ–¹å‘": {
                insight: ["è§€å¯Ÿå»£å‘Šæ•´é«”æˆæ•ˆï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºç›®å‰å¸³æˆ¶æŠ•éç­–ç•¥èƒ½æœ‰æ•ˆç¶­æŒç©©å®šèµ°å‹¢ã€‚", "æª¢è¦–æœ¬é€±æ•´é«”æ•¸æ“šï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºå¸‚å ´ç«¶åƒ¹ç’°å¢ƒä¹‹è®Šå‹•ã€‚"],
                action: ["é‡å°ç›®å‰${val}è¶¨å‹¢ï¼Œå·²å®Œæˆå‡ºåƒ¹åƒæ•¸æ ¡æ­£ï¼Œä»¥ç©©å®šé•·æœŸä¹‹ç²å®¢æˆæœ¬ã€‚", "ä¸‹é€±è¨ˆç•«é€²è¡Œæ·±åº¦è¨ºæ–·ï¼Œä¸¦è¦–æƒ…æ³èª¿æ•´å‡ºåƒ¹ç­–ç•¥ä»¥æœ€å¤§åŒ–æ•ˆç›Šã€‚"]
            },
            "ç´ æèˆ‡ç‰ˆä½è¡¨ç¾": {
                insight: ["ç´ ææ–¹é¢ï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºç›®å‰è¦–è¦ºåˆ‡é»å°å®¢ç¾¤ä¹‹å¸å¼•åŠ›ã€‚", "åˆ†æç´ æå›é¥‹ï¼Œ${val} ${comp}åæ˜ å‡ºç›®å‰ç´ ææ–¹å‘ç¬¦åˆå¸‚å ´è¶¨å‹¢ã€‚"],
                action: ["å·²å®Œæˆè¡¨ç¾è¼ƒå·®ä¹‹ç´ ææ±°æ›ï¼Œä¸¦é‡å°${val}ä¹‹æˆæ•ˆåé¥‹åŠ å¼·æ¨å»£åŠ›é“ã€‚", "ä¸‹é€±é è¨ˆæ¸¬è©¦æ–°ç´ æçµ„ä»¶ï¼Œé‡é»æ”¾åœ¨å¼·åŒ–${val}ä¹‹è¡¨ç¾ã€‚"]
            },

            "å®¢å±¤è¡¨ç¾": {
                insight: ["åˆ†æå®¢å±¤è¡¨ç¾ï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºç›®å‰å»£å‘Šèƒ½æœ‰æ•ˆè§¸åŠç›®æ¨™æ—ç¾¤ã€‚", "æª¢è¦–å®¢å±¤æ•¸æ“šï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºä¸»åŠ›å®¢ç¾¤ä¹‹å—çœ¾ç‰¹å¾µã€‚"],
                action: ["æœ¬é€±å·²é‡å°å—çœ¾${val}ä¹‹åé¥‹ï¼Œå¾®èª¿äº†ç‰¹å®šå¹´é½¡èˆ‡æ€§åˆ¥ä¹‹å‡ºåƒ¹æ¬Šé‡ã€‚", "ä¸‹é€±é è¨ˆç›£æ¸¬å®¢å±¤${val}ä¹‹èµ°å‹¢ï¼Œä¸¦è©•ä¼°æ˜¯å¦å°å…¥æ›´ç²¾ç´°æ¨™ç±¤ã€‚"]
            },

            "å—çœ¾è¡¨ç¾": {
                insight: ["åˆ†æå—çœ¾è¡¨ç¾ï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºç›®å‰å»£å‘Šä¿¡è™Ÿèƒ½æœ‰æ•ˆè§¸åŠç›®æ¨™æ—ç¾¤ã€‚", "æª¢è¦–å—çœ¾æ•¸æ“šï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºä¸»åŠ›å®¢ç¾¤ä¹‹å—çœ¾ç‰¹å¾µã€‚"],
                action: ["æœ¬é€±å·²é‡å°å—çœ¾${val}ä¹‹åé¥‹ï¼Œå¾®èª¿äº† ${val} ${comp} ä¹‹å‡ºåƒ¹æ¬Šé‡ã€‚", "ä¸‹é€±é è¨ˆç›£æ¸¬å—çœ¾${val}ä¹‹æ•¸æ“šèµ°å‹¢ï¼Œæ»¾å‹•å¼èª¿æ•´å‡ºåƒ¹å¹…åº¦ã€‚"]
            },
            "æœå°‹èˆ‡é—œéµå­—åˆ†æ": {
                insight: ["è§€å¯Ÿé—œéµå­—è¡¨ç¾ï¼Œ${val} ${comp}ï¼Œåæ˜ å‡ºæ ¸å¿ƒå­—çµ„æˆåŠŸæ””æˆªç²¾æº–æµé‡ã€‚", "æœå°‹åˆ†æé¡¯ç¤ºï¼Œ${val} ${comp}ï¼Œé¡¯ç¤ºå»£å‘Šåœ¨é«˜åº¦æœå°‹æ„åœ–å—çœ¾ä¸­å…·å‚™ç«¶çˆ­åŠ›ã€‚"],
                action: ["é‡å°é—œéµå­—${val}ä¹‹ç¾ç‹€ï¼Œå·²åŸ·è¡Œå­—è©æ¯”å°æ¨¡å¼å„ªåŒ–ä¸¦æ’é™¤é›œè¨Šã€‚", "ä¸‹é€±è¨ˆç•«é‡å°ã€Œ${val}ã€ä¹‹æœé‡è¶¨å‹¢è§€æ¸¬ï¼Œä¸¦æ ¹æ“šåé¥‹èª¿æ•´å‡ºåƒ¹ã€‚"]
        };

        // æ–‡å­—æ ¼å¼åŒ–æŒ‡ä»¤
        function format(cmd, val = null) { document.execCommand(cmd, false, val); run(); }

        function updateLevel2() {
            const l1 = document.getElementById('level1').value;
            const l2 = document.getElementById('level2');
            l2.innerHTML = "";
            (level2Options[l1] || []).forEach(opt => l2.add(new Option(opt, opt)));
        }

        function formatCompVal(val, metric) {
            if (!val) return "";
            let clean = val.toString().replace(/[$,%\s]/g, '');
            let num = parseFloat(clean);
            if (isNaN(num)) return val;
            let formatted = new Intl.NumberFormat('zh-TW').format(num);
            if (["æˆæœ¬", "CPC", "CPA"].some(k => metric.includes(k))) return "$" + formatted;
            if (["ç‡", "é€²åº¦", "CTR"].some(k => metric.includes(k))) return formatted + "%";
            return formatted;
        }

        function addStage(type) {
            const l1 = document.getElementById('level1').value;
            const input = document.getElementById('obsInput').value;
            if (!input) return;
            const curVal = document.getElementById('comp_this').value;
            const preVal = document.getElementById('comp_prev').value;
            let compStr = (curVal && preVal) ? `(${formatCompVal(preVal, 'æ•¸å­—')} â†’ ${formatCompVal(curVal, 'æ•¸å­—')})` : "";
            const pool = db[l1][type] || db[l1]["insight"];
            const text = pool[Math.floor(Math.random() * pool.length)].replace('${val}', input).replace('${comp}', compStr);
            const target = document.getElementById(type === 'insight' ? 'stageInsight' : 'stageAction');
            target.innerHTML += (target.innerHTML ? '<br>' : '') + text;
            document.getElementById('obsInput').value = ""; run();
        }

        function parseBulkData() {
            const raw = document.getElementById('bulkPaste').value.trim();
            if (!raw) return;
            const lines = raw.split(/\n/).map(line => line.split(/\t/));
            let data = lines.length < 2 ? raw.split(/\n/).map(line => line.trim().split(/\s{2,}/)) : lines;
            const h = data[0], v = data[data.length - 1];
            const m = { imp: ["æ›å…‰"], click: ["é»æ“Š"], conv: ["è½‰æ›"], ctr: ["CTR"], cpc: ["CPC"], cpa: ["CPA"], progress: ["é€²åº¦"] };
            h.forEach((header, idx) => {
                for (let k in m) {
                    if (m[k].some(key => header.includes(key))) {
                        let val = v[idx] ? v[idx].replace(/[$,%\s]/g, '') : "";
                        if (k === 'progress') { document.getElementById('v-progress').value = val; }
                        else if (document.getElementById('v-' + k)) {
                            document.getElementById('v-' + k).value = val;
                            document.querySelector(`.m-check[value="${k}"]`).checked = true;
                        }
                    }
                }
            });
            toggleInputs(); run();
        }

        function toggleInputs() {
            document.querySelectorAll('.m-check').forEach(ck => {
                const div = document.getElementById('div-' + ck.value);
                if(div) ck.checked ? div.classList.remove('hidden') : div.classList.add('hidden');
            });
            run();
        }

        // ä¿®æ”¹é è¦½çš„æ ¸å¿ƒå‡½å¼ï¼šç¢ºä¿ HTML èˆ‡ Textarea éƒ½èƒ½æ­£ç¢ºè®€å–
        function run() {
            const getVal = (id) => {
                const el = document.getElementById(id);
                if (!el) return "";
                // å¦‚æœæ˜¯å¯Œæ–‡æœ¬ç·¨è¼¯æ¡†(div)ï¼ŒæŠ“ innerHTMLï¼›å¦å‰‡æŠ“ value
                return el.contentEditable === "true" ? el.innerHTML : el.value;
            };

            const s = getVal('sDate').replace(/-/g, '/') || '__/__/__', e = getVal('eDate').replace(/-/g, '/') || '__/__/__';
            const platforms = Array.from(document.querySelectorAll('.p-check:checked')).map(p => p.value);
            
            let perf = [];
            const labels = {imp:"æ›å…‰", click:"é»æ“Š", conv:"è½‰æ›", ctr:"CTR", cpc:"CPC", cpa:"CPA"};
            document.querySelectorAll('.m-check:checked').forEach(ck => {
                perf.push(`${labels[ck.value]} ${formatCompVal(getVal('v-' + ck.value), labels[ck.value])}`);
            });
            
            const progress = getVal('v-progress') ? `ç›®å‰èŠ±è²»é€²åº¦ï¼š${getVal('v-progress')}%<br>` : '';

            // ä½¿ç”¨ innerHTML é€²è¡Œæ¸²æŸ“ï¼Œé€™æ‰èƒ½é¡¯ç¤ºç²—é«”å’Œé¡è‰²
            document.getElementById('preview').innerHTML = `Dear all,<br><br>` +
                `é™„ä»¶ç‚º ${getVal('client') || '[å®¢æˆ¶]'} ${platforms.join(' + ') || '[å¹³å°]'} å»£å‘Šå ±è¡¨ï¼Œè«‹æŸ¥é–±ã€‚<br><br>` +
                `ã€å¸³æˆ¶ç‹€æ³èªªæ˜ã€‘<br>` +
                `å»£å‘ŠæœŸé–“ï¼š${s} - ${e}<br>` +
                `å»£å‘Šæˆæ•ˆï¼š${perf.join('ã€')}<br>` +
                `${progress}<br>` +
                `ã€å„ªåŒ–åˆ†æèˆ‡å»ºè­°ã€‘<br>` +
                `æ•¸æ“šæ´å¯Ÿï¼š<br>${getVal('stageInsight') || 'æ´å¯Ÿå…§å®¹'}<br><br>` +
                `ä¸‹ä¸€æ­¥è¡Œå‹•ï¼š<br>${getVal('stageAction') || 'è¡Œå‹•è¦åŠƒ'}<br><br>` +
                `Best regards,`;
        }

        function saveToHistory() {
            const c = document.getElementById('client').value; if (!c) return alert('è«‹è¼¸å…¥åç¨±');
            const h = { id: Date.now(), time: new Date().toLocaleString(), client: c, insight: document.getElementById('stageInsight').innerHTML, action: document.getElementById('stageAction').innerHTML };
            let history = JSON.parse(localStorage.getItem('tpl_v30_history') || '[]');
            history.unshift(h); localStorage.setItem('tpl_v30_history', JSON.stringify(history));
            alert('âœ… å·²å°å­˜ï¼');
        }

        function openHistory() {
            const history = JSON.parse(localStorage.getItem('tpl_v30_history') || '[]');
            const list = document.getElementById('historyList'); list.innerHTML = history.length ? '' : 'ç„¡ç´€éŒ„';
            history.forEach(item => {
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<div>${item.time.split(' ')[0]}</div><div>${item.client}</div><div>ç´€éŒ„...</div><button class="btn btn-outline" onclick="loadFromHistory(${item.id})">è¼‰å…¥</button>`;
                list.appendChild(div);
            });
            document.getElementById('historyModal').style.display = 'block';
        }

        function loadFromHistory(id) {
            const history = JSON.parse(localStorage.getItem('tpl_v30_history') || '[]');
            const item = history.find(i => i.id === id); if (!item) return;
            document.getElementById('stageInsight').innerHTML = item.insight;
            document.getElementById('stageAction').innerHTML = item.action;
            run(); closeHistory();
        }

        function copy() {
            const p = document.getElementById('preview');
            const r = document.createRange(); r.selectNode(p);
            window.getSelection().removeAllRanges(); window.getSelection().addRange(r);
            document.execCommand('copy'); alert('å ±è¡¨å·²è¤‡è£½(å«æ ¼å¼)ï¼');
        }

        function closeHistory() { document.getElementById('historyModal').style.display = 'none'; }
        function resetDefault() { if(confirm('é‡ç½®ï¼Ÿ')) location.reload(); }
        function saveTemplate() { alert('ç¯„æœ¬å„²å­˜æˆåŠŸ'); }
        function exportTemplates() { alert('è¨­å®šå·²åŒ¯å‡º'); }
        function importTemplates() { alert('è¨­å®šå·²åŒ¯å…¥'); }

        window.onload = () => { updateLevel2(); run(); };
    </script>
</body>
</html>
